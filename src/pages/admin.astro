---
// src/pages/admin.astro
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import { validateToken, getWhatsAppNumber } from '../data/auth';

// Verificar autenticación
const token = Astro.cookies.get('auth_token')?.value;
if (!token || !validateToken(token)) {
  return Astro.redirect('/admin-login');
}

// Obtener número actual
const currentNumber = await getWhatsAppNumber();
---

<Layout title="Panel de Administración">
  <main class="container mx-auto py-10 px-4 max-w-md">
    <h1 class="text-2xl font-bold mb-6 text-center">Panel de Administración</h1>
    
    <div class="bg-white p-6 rounded-lg shadow-md">
      <form id="updateForm" class="mb-6">
        <div class="mb-4">
          <label for="whatsappNumber" class="block text-gray-700 mb-2">Número de WhatsApp:</label>
          <input 
            type="text" 
            id="whatsappNumber" 
            value={currentNumber}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
          <p class="text-sm text-gray-500 mt-1">Solo números, sin símbolos (ej: 541112345678)</p>
        </div>
        
        <button 
          type="submit" 
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300"
        >
          Actualizar Número
        </button>
        
        <div id="statusMessage" class="mt-4 text-center hidden"></div>
      </form>
      
      <button 
        id="logoutButton"
        class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300"
      >
        Cerrar Sesión
      </button>
    </div>
  </main>
</Layout>

<script>
  const updateForm = document.getElementById('updateForm') as HTMLFormElement;
  const statusMessage = document.getElementById('statusMessage') as HTMLDivElement;
  const logoutButton = document.getElementById('logoutButton') as HTMLButtonElement;
  
  // Obtener token
  function getToken() {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith('auth_token='))
      ?.split('=')[1];
  }
  
  updateForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const numberInput = document.getElementById('whatsappNumber') as HTMLInputElement;
    const number = numberInput.value.trim();
    
    if (!/^\d+$/.test(number)) {
      showStatus('El número debe contener solo dígitos', 'error');
      return;
    }
    
    try {
      const token = getToken();
      
      const response = await fetch('/api/updateNumber', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ number })
      });
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        showStatus('Número actualizado correctamente', 'success');
      } else {
        showStatus(data.error || 'Error al actualizar', 'error');
      }
    } catch (error) {
      showStatus('Error de conexión', 'error');
    }
  });
  
  logoutButton.addEventListener('click', () => {
    document.cookie = 'auth_token=; path=/; max-age=0';
    window.location.href = '/admin-login';
  });
  
  function showStatus(message: string, type: 'success' | 'error') {
    statusMessage.textContent = message;
    statusMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
    statusMessage.classList.add(type === 'success' ? 'text-green-500' : 'text-red-500');
  }
</script>